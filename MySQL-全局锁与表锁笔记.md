---
title:  MySQL 全局锁与表锁笔记
date: 2019-10-27 17:50:15
tags: ["MySQL"]
categories: "MySQL"
---

# MySQL-全局锁与表锁笔记

> 数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。

**根据加锁的范围,MySQL的锁大致可分为全局锁,表级锁和行锁三类**

## 全局锁

全局锁就是对整个数据库实例加锁

- MySQL提供了一个加全局读锁的方法,命令是`Flush tables with read lock`简称**FTWRL**

使用FTWRL会让整个库处于读状态,之后其他线程的**数据更新语句,数据定义语句,更新类事务的提交语句**就会被阻塞

全局锁的典型应用场景就是**全库逻辑备份**

在使用全局锁会让整个库都只读会出现的风险也非常大

- 若在主库上备份,那么在备份期间都不能执行更新,业务基本上就得停摆
- 若在从库上备份,那么在备份期间从库不能执行主库同步过来的binlog,会导致主从延迟

但是不加锁的话，备份系统备份的得到的库不是一个逻辑时间点，这个视图是逻辑不一致的

官方自带的逻辑备份工具是**mysqldump**。当mysqldump使用参数**–single-transaction**的时候,导数据之前就会启动一个事务,来确保拿到一致性视图.而由于MVCC的支持,这个过程中数据是可以正常更新的

> 一致性读是好,但前提是要引擎支持这个隔离级别即可重复读的隔离级别
>
> 若引擎不支持事务,那么就需要FTWRL命令
>
> 以上可知,**single-transaction方法只适用于所有的表使用事务引擎的库**

除了以上说的这两个方式,其实我们知道还可以通过修改**全局可读**`set global readonly = true`

这样做的风险在于以下两个

- 在有些系统中,readonly值会被用来做

## 参考

<https://time.geekbang.org/column/intro/139>